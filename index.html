<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CrimePrint</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: Arial;
      background: linear-gradient(to right, #111, #222);
      color: white;
      padding: 40px;
      display: flex;
      justify-content: center;
    }

    #box {
      background: #1e1e1e;
      width: 380px;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0px 0px 25px rgba(0,0,0,0.5);
      border: 1px solid #333;
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    #status {
      color: #4fc3f7;
      font-weight: bold;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 6px;
      border: none;
      background: #2a2a2a;
      color: white;
      outline: none;
      font-size: 15px;
    }

    textarea {
      height: 80px;
      resize: none;
    }

    input::placeholder, textarea::placeholder {
      color: #999;
    }

    .btn {
      width: 48%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      margin-top: 15px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s ease;
    }

    .save-btn { background: #43a047; color: white; }
    .save-btn:hover { background: #2e7d32; }

    .discard-btn { background: #e53935; color: white; }
    .discard-btn:hover { background: #b71c1c; }

    .update-btn { background: #1e88e5; width: 100%; margin-top: 10px; color: white; }
    .update-btn:hover { background: #1565c0; }

    .section-title {
      margin-top: 18px;
      font-weight: bold;
      color: #4fc3f7;
      margin-bottom: 5px;
    }

    .info-text {
      background: #2a2a2a;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      color: #ddd;
    }
  </style>
</head>

<body>

<div id="box">
  <h2>CrimePrint System</h2>

  <p><strong>Status:</strong> <span id="status">Waiting...</span></p>
  <p><strong>Fingerprint ID:</strong> <span id="scanID">None</span></p>

  <!-- New fingerprint information input -->
  <div id="newInfoBox" style="display:none;">
    <p class="section-title">Enter Criminal Details</p>
    <input id="userName" placeholder="Name">
    <textarea id="userDetails" placeholder="Crime details"></textarea>

    <div style="display:flex; justify-content:space-between;">
      <button id="saveBtn" class="btn save-btn" style="display:none;">SAVE</button>
      <button id="discardBtn" class="btn discard-btn" style="display:none;">DON'T SAVE</button>
    </div>
  </div>

  <!-- Existing user info -->
  <div id="existingInfoBox" style="display:none;">
    <p class="section-title">Previous Record:</p>
    <div class="info-text" id="prevName"></div>
    <div class="info-text" id="prevDetails"></div>

    <p class="section-title">Update Information:</p>
    <input id="updateName" placeholder="Update Name">
    <textarea id="updateDetails" placeholder="Update Details"></textarea>

    <button id="updateSaveBtn" class="btn update-btn">SAVE UPDATE</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDtitp4EmZH3PbkzbHJKcDX9dy1nFhleQc",
    authDomain: "crimeprint-4cf4e.firebaseapp.com",
    databaseURL: "https://crimeprint-4cf4e-default-rtdb.firebaseio.com",
    projectId: "crimeprint-4cf4e",
    storageBucket: "crimeprint-4cf4e.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const statusEl = document.getElementById("status");
  const scanIDEl = document.getElementById("scanID");

  const newInfoBox = document.getElementById("newInfoBox");
  const existingInfoBox = document.getElementById("existingInfoBox");

  const userName = document.getElementById("userName");
  const userDetails = document.getElementById("userDetails");

  const prevName = document.getElementById("prevName");
  const prevDetails = document.getElementById("prevDetails");

  const updateName = document.getElementById("updateName");
  const updateDetails = document.getElementById("updateDetails");
  const updateSaveBtn = document.getElementById("updateSaveBtn");

  const saveBtn = document.getElementById("saveBtn");
  const discardBtn = document.getElementById("discardBtn");

  // CLEAR FIELDS FUNCTION
  function clearAllFields() {
    userName.value = "";
    userDetails.value = "";
    updateName.value = "";
    updateDetails.value = "";
    prevName.innerText = "";
    prevDetails.innerText = "";
  }

  // Listen for fingerprint events
  db.ref("scan").on("value", async (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    const id = data.last;
    const pending = data.pending;

    scanIDEl.innerText = id;

    // New fingerprint
    if (pending === true) {
      clearAllFields();
      statusEl.innerText = "New fingerprint detected";

      newInfoBox.style.display = "block";
      existingInfoBox.style.display = "none";
      saveBtn.style.display = "inline-block";
      discardBtn.style.display = "inline-block";
    }

    // Matched fingerprint
    if (pending === false && id > 0) {
      clearAllFields();
      statusEl.innerText = "Fingerprint MATCHED";

      newInfoBox.style.display = "none";
      saveBtn.style.display = "none";
      discardBtn.style.display = "none";

      const userSnap = await db.ref("users/" + id).get();

      if (userSnap.exists()) {
        const user = userSnap.val();
        prevName.innerText = "Name: " + user.name;
        prevDetails.innerText = "Details: " + user.details;
      } else {
        prevName.innerText = "No previous record.";
        prevDetails.innerText = "";
      }

      existingInfoBox.style.display = "block";
    }
  });

  // Save new user
  saveBtn.onclick = () => {
    const id = scanIDEl.innerText;

    const info = {
      name: userName.value,
      details: userDetails.value
    };

    db.ref("users/" + id).set(info);

    db.ref("scan/command").set("save");
    db.ref("scan/pending").set(false);

    statusEl.innerText = "Saved!";
    clearAllFields();
    newInfoBox.style.display = "none";
  };

  // Discard new user
  discardBtn.onclick = () => {
    db.ref("scan/command").set("discard");
    db.ref("scan/pending").set(false);

    statusEl.innerText = "Discarded!";
    clearAllFields();
    newInfoBox.style.display = "none";
  };

  // Update existing user
  updateSaveBtn.onclick = () => {
    const id = scanIDEl.innerText;

    const updated = {
      name: updateName.value,
      details: updateDetails.value
    };

    db.ref("users/" + id).update(updated);
    statusEl.innerText = "Updated!";
  };
</script>

</body>
</html>
