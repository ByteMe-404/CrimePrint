<!DOCTYPE html>
<html>

<head>
  <title>CrimePrint</title>
  <style>
    body {
      font-family: "Segoe UI", Arial;
      background: #f0f3f7;
      display: flex;
      justify-content: center;
      padding-top: 50px;
    }

    #container {
      width: 380px;
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0px 5px 20px rgba(0, 0, 0, 0.15);
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }

    #status {
      padding: 10px;
      font-weight: bold;
      background: #e8eef6;
      color: #1a3d7c;
      border-radius: 10px;
      display: inline-block;
      width: 100%;
      text-align: center;
      margin-bottom: 20px;
    }

    .box-section {
      padding: 18px;
      background: #fafafa;
      border-radius: 12px;
      margin-top: 10px;
      border: 1px solid #ddd;
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 10px;
      font-size: 15px;
    }

    button {
      width: 100%;
      margin-top: 15px;
      padding: 12px;
      background: #1a73e8;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #0b59c7;
    }

    .found {
      color: #0c8c2c;
      font-weight: bold;
    }

    .not-found {
      color: #c91d1d;
      font-weight: bold;
    }
  </style>
</head>

<body>

<div id="container">
  <h2>üîç CrimePrint Fingerprint System</h2>

  <div id="status">Waiting...</div>

  <div id="new-user" class="box-section" style="display:none;">
    <h3 class="not-found">New Fingerprint Detected</h3>
    <p><b>New ID:</b> <span id="newID"></span></p>

    <input id="nameInput" placeholder="Enter full name">
    <button onclick="saveName()">Save Name</button>
  </div>

  <div id="found-user" class="box-section" style="display:none;">
    <h3 class="found">Match Found</h3>
    <p><b>ID:</b> <span id="foundID"></span></p>
    <p><b>Name:</b> <span id="foundName"></span></p>
  </div>
</div>

<script type="module">

  // FIREBASE IMPORTS
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, get } 
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyATRJk4sSFb0er9E83nxdEMbgRAPDw9BXg",
    authDomain: "crimeprint-4cf4e.firebaseapp.com",
    databaseURL: "https://crimeprint-4cf4e-default-rtdb.firebaseio.com",
    projectId: "crimeprint-4cf4e",
    storageBucket: "crimeprint-4cf4e.firebasestorage.app",
    messagingSenderId: "7136933754",
    appId: "1:7136933754:web:d369fc2dc9c1eb839208c3",
    measurementId: "G-TFLEE8SXET"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const statusBox = document.getElementById("status");
  const newUserBox = document.getElementById("new-user");
  const foundUserBox = document.getElementById("found-user");
  const nameInput = document.getElementById("nameInput");

  let currentID = null;

  // Listen for ESP32 scan events
  onValue(ref(db, "scan/last"), async (snapshot) => {
    const id = snapshot.val();
    if (!id) return;

    currentID = id;
    statusBox.textContent = "Processing Scan: " + id;

    const fpSnap = await get(ref(db, "fingerprints/" + id));

    if (fpSnap.exists()) {
      newUserBox.style.display = "none";
      foundUserBox.style.display = "block";

      document.getElementById("foundID").textContent = id;
      document.getElementById("foundName").textContent = fpSnap.val().name;

      statusBox.textContent = "Match Found!";
    } else {
      foundUserBox.style.display = "none";
      newUserBox.style.display = "block";

      document.getElementById("newID").textContent = id;
      nameInput.value = "";

      statusBox.textContent = "New Fingerprint Detected";
    }
  });

  // Save new fingerprint name
  async function saveName() {
    const name = nameInput.value.trim();

    if (!name) {
      alert("Enter a name.");
      return;
    }

    statusBox.textContent = Saving "${name}"...;

    await set(ref(db, "fingerprints/" + currentID), { name });

    alert("Saved!");

    newUserBox.style.display = "none";
    foundUserBox.style.display = "block";

    document.getElementById("foundID").textContent = currentID;
    document.getElementById("foundName").textContent = name;

    statusBox.textContent = "Saved Successfully!";
  }

  window.saveName = saveName;

</script>

</body>
</html>
